<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link rel="icon" type="image/svg+xml" href="../vite.svg" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    #nc-root {
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <!-- Clean container for Decap CMS -->
  <div id="nc-root"></div>
  
  <script>
    // Prevent any automatic initialization
    window.CMS_MANUAL_INIT = true;
    
    // Clean initialization function
    function initDecapCMS() {
      console.log('Starting Decap CMS initialization...');
      
      // Ensure container is clean
      const container = document.getElementById('nc-root');
      if (container) {
        container.innerHTML = ''; // Clear any existing content
        console.log('Container cleared and ready');
      }
      
      // Load Decap CMS script dynamically to ensure proper timing
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
      script.onload = function() {
        console.log('Decap CMS script loaded');
        
        // Small delay to ensure everything is ready
        setTimeout(() => {
          try {
            if (window.CMS) {
              console.log('Initializing CMS with embedded config...');
              
              // Initialize with embedded DecapBridge PKCE configuration
              window.CMS.init({
                config: {
                  backend: {
                    name: 'git-gateway',
                    repo: 'kitgore/indigoroom',
                    branch: 'main',
                    auth_type: 'pkce',
                    base_url: 'https://auth.decapbridge.com',
                    auth_endpoint: '/sites/a554038d-d544-44e5-9ac7-09ba62b247a3/pkce',
                    auth_token_endpoint: '/sites/a554038d-d544-44e5-9ac7-09ba62b247a3/token',
                    gateway_url: 'https://gateway.decapbridge.com',
                    commit_messages: {
                      create: 'Create {{collection}} "{{slug}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      update: 'Update {{collection}} "{{slug}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      delete: 'Delete {{collection}} "{{slug}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      uploadMedia: 'Upload "{{path}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      deleteMedia: 'Delete "{{path}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      openAuthoring: 'Message {{message}} - {{author-name}} <{{author-login}}> via DecapBridge'
                    }
                  },
                  auth: {
                    email_claim: 'email',
                    first_name_claim: 'first_name',
                    last_name_claim: 'last_name',
                    avatar_url_claim: 'avatar_url'
                  },
                  logo_url: 'https://decapbridge.com/decapcms-with-bridge.svg',
                  site_url: 'https://kitgore.github.io/indigoroom',
                  display_url: 'https://kitgore.github.io/indigoroom',
                  media_folder: 'src/assets/uploads',
                  public_folder: '/indigoroom/src/assets/uploads',
                  collections: [
                    {
                      name: 'site_content',
                      label: 'Site Content',
                      files: [
                        {
                          label: 'Hours',
                          name: 'hours',
                          file: 'src/content/hours.json',
                          fields: [
                            {
                              label: 'Hours',
                              name: 'hours',
                              widget: 'list',
                              fields: [
                                { label: 'Day', name: 'day', widget: 'string' },
                                { label: 'Time', name: 'time', widget: 'string' }
                              ]
                            }
                          ]
                        },
                        {
                          label: 'Menu',
                          name: 'menu',
                          file: 'src/content/menu.json',
                          fields: [
                            {
                              label: 'Menu Categories',
                              name: 'categories',
                              widget: 'list',
                              fields: [
                                { label: 'Category Name', name: 'name', widget: 'string' },
                                {
                                  label: 'Items',
                                  name: 'items',
                                  widget: 'list',
                                  fields: [
                                    { label: 'Item Name', name: 'name', widget: 'string' },
                                    { label: 'Description', name: 'description', widget: 'text', required: false },
                                    { label: 'Price', name: 'price', widget: 'string', required: false }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          label: 'About',
                          name: 'about',
                          file: 'src/content/about.json',
                          fields: [
                            { label: 'Title', name: 'title', widget: 'string' },
                            { label: 'Description', name: 'description', widget: 'markdown' }
                          ]
                        },
                        {
                          label: 'Site Settings',
                          name: 'settings',
                          file: 'src/content/settings.json',
                          fields: [
                            { label: 'Site Title', name: 'title', widget: 'string' },
                            { label: 'Site Description', name: 'description', widget: 'text' },
                            { label: 'Contact Email', name: 'email', widget: 'string', required: false },
                            { label: 'Phone', name: 'phone', widget: 'string', required: false },
                            { label: 'Address', name: 'address', widget: 'text', required: false }
                          ]
                        }
                      ]
                    }
                  ]
                }
              });
              
              console.log('CMS initialization complete with DecapBridge PKCE config');
              
              // Register preview styles to match the main site (inline for GitHub Pages compatibility)
              window.CMS.registerPreviewStyle(`
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
                
                body {
                  font-family: 'Inter', 'Arial', sans-serif;
                  background-color: #EBEBEB;
                  margin: 0;
                  padding: 2rem;
                  color: #111;
                  line-height: 1.5;
                }
                
                h2 {
                  font-size: 2.5rem;
                  font-weight: 500;
                  margin-bottom: 1em;
                  color: #111;
                }
                
                h3 {
                  font-size: 1.5rem;
                  font-weight: 500;
                  color: #4a74c9;
                  margin-bottom: 0.5em;
                }
                
                p {
                  font-size: 1.1rem;
                  font-weight: 500;
                  line-height: 1.6;
                  margin-bottom: 1.5em;
                  color: #333;
                }
                
                .hours-list {
                  display: grid;
                  gap: 0.5em;
                  margin-left: 1rem;
                }
                
                .hours-item {
                  font-size: 1.3em;
                  color: #4a74c9;
                  font-weight: 500;
                }
                
                .menu-grid {
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 3em;
                }
                
                .menu-category {
                  break-inside: avoid;
                  margin-bottom: 2em;
                }
                
                .menu-category h3 {
                  font-size: 1.5rem;
                  margin-bottom: 1em;
                  color: #4a74c9;
                }
                
                .menu-category ul {
                  list-style: none;
                  padding: 0;
                  margin: 0;
                }
                
                .menu-category li {
                  font-size: 1.1rem;
                  margin-bottom: 0.5em;
                  color: #333;
                  display: flex;
                  flex-direction: column;
                  gap: 0.3em;
                }
                
                .item-row {
                  display: flex;
                  justify-content: space-between;
                  align-items: baseline;
                  gap: 1em;
                }
                
                .item-name {
                  font-weight: 500;
                  flex: 1;
                }
                
                .item-description {
                  font-size: 0.9em;
                  color: #666;
                  font-style: italic;
                  margin-left: 0.3em;
                  line-height: 1.6;
                }
                
                .item-prices {
                  display: flex;
                  gap: 1.5em;
                  flex-shrink: 0;
                }
                
                .item-price {
                  font-size: 0.95em;
                  color: #4a74c9;
                  font-weight: 500;
                  min-width: 3em;
                  text-align: right;
                }
                
                .flavor-text {
                  text-align: center;
                  width: 70%;
                  margin: 1em auto;
                  font-size: 1.1rem;
                  line-height: 1.6;
                  color: #333;
                }
                
                .about-content p {
                  font-size: 1.1rem;
                  line-height: 1.6;
                  margin-bottom: 1.5em;
                  color: #333;
                }
                
                .quotes-list {
                  display: flex;
                  flex-wrap: wrap;
                  gap: 0.5em;
                }
                
                .quote-item {
                  background: #4a74c9;
                  color: white;
                  padding: 0.5em 1em;
                  border-radius: 4px;
                  font-size: 0.9rem;
                }
                
                .settings-preview {
                  background: white;
                  padding: 1.5rem;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                
                .settings-preview dt {
                  font-weight: 500;
                  color: #4a74c9;
                  margin-top: 1em;
                }
                
                .settings-preview dd {
                  margin: 0.3em 0 0 0;
                  color: #333;
                }
                
                ul { list-style: none; padding: 0; }
                li { margin-bottom: 0.5em; }
                a { color: #4a74c9; text-decoration: underline; }
                strong { font-weight: 600; }
                em { font-style: italic; }
                blockquote { border-left: 3px solid #4a74c9; padding-left: 1em; margin: 1em 0; color: #666; }
                code { background: #f0f0f0; padding: 0.2em 0.4em; border-radius: 3px; font-family: monospace; }
              `, { raw: true });
              
              // Custom preview template for Hours
              const HoursPreview = window.createClass({
                render: function() {
                  const entry = this.props.entry;
                  const hours = entry.getIn(['data', 'hours']);
                  
                  return window.h('div', {},
                    window.h('h2', {}, 'hours'),
                    window.h('div', { className: 'hours-list' },
                      hours && hours.map(function(hour, index) {
                        return window.h('h3', { key: index, className: 'hours-item' },
                          hour.get('day').toLowerCase() + ': ' + hour.get('time')
                        );
                      }).toArray()
                    )
                  );
                }
              });
              window.CMS.registerPreviewTemplate('hours', HoursPreview);
              
              // Custom preview template for Menu
              const MenuPreview = window.createClass({
                render: function() {
                  const entry = this.props.entry;
                  const categories = entry.getIn(['data', 'categories']);
                  const flavorText = entry.getIn(['data', 'flavorText']);
                  
                  return window.h('div', {},
                    window.h('h2', {}, 'menu'),
                    flavorText && window.h('p', { className: 'flavor-text' }, flavorText),
                    window.h('div', { className: 'menu-grid' },
                      categories && categories.map(function(category, catIndex) {
                        return window.h('div', { key: catIndex, className: 'menu-category' },
                          window.h('h3', {}, category.get('name')),
                          window.h('ul', {},
                            category.get('items') && category.get('items').map(function(item, itemIndex) {
                              return window.h('li', { key: itemIndex },
                                window.h('div', { className: 'item-row' },
                                  window.h('span', { className: 'item-name' }, item.get('name')),
                                  window.h('div', { className: 'item-prices' },
                                    item.get('smallprice') && window.h('span', { className: 'item-price' }, item.get('smallprice')),
                                    item.get('largeprice') && window.h('span', { className: 'item-price' }, item.get('largeprice'))
                                  )
                                ),
                                item.get('description') && window.h('span', { className: 'item-description' }, item.get('description'))
                              );
                            }).toArray()
                          )
                        );
                      }).toArray()
                    )
                  );
                }
              });
              window.CMS.registerPreviewTemplate('menu', MenuPreview);
              
              // Custom preview template for About
              const AboutPreview = window.createClass({
                render: function() {
                  const entry = this.props.entry;
                  const title = entry.getIn(['data', 'title']);
                  const description = entry.getIn(['data', 'description']);
                  
                  return window.h('div', {},
                    window.h('h2', {}, title || 'about'),
                    window.h('div', { className: 'about-content' },
                      description && description.split('\n\n').map(function(paragraph, index) {
                        return window.h('p', { key: index }, paragraph);
                      })
                    )
                  );
                }
              });
              window.CMS.registerPreviewTemplate('about', AboutPreview);
              
              // Custom preview template for Indigo Quotes
              const QuotesPreview = window.createClass({
                render: function() {
                  const entry = this.props.entry;
                  const textBank = entry.getIn(['data', 'textBank']);
                  
                  return window.h('div', {},
                    window.h('h2', {}, 'indigo quotes'),
                    window.h('div', { className: 'quotes-list' },
                      textBank && textBank.map(function(quote, index) {
                        return window.h('span', { key: index, className: 'quote-item' }, quote);
                      }).toArray()
                    )
                  );
                }
              });
              window.CMS.registerPreviewTemplate('indigo-quotes', QuotesPreview);
              
              // Custom preview template for Settings
              const SettingsPreview = window.createClass({
                render: function() {
                  const entry = this.props.entry;
                  const data = entry.get('data');
                  
                  return window.h('div', { className: 'settings-preview' },
                    window.h('h2', {}, 'site settings'),
                    window.h('dl', {},
                      window.h('dt', {}, 'Title'),
                      window.h('dd', {}, data.get('title')),
                      window.h('dt', {}, 'Description'),
                      window.h('dd', {}, data.get('description')),
                      data.get('email') && [window.h('dt', { key: 'email-label' }, 'Email'), window.h('dd', { key: 'email-value' }, data.get('email'))],
                      data.get('phone') && [window.h('dt', { key: 'phone-label' }, 'Phone'), window.h('dd', { key: 'phone-value' }, data.get('phone'))],
                      data.get('address') && [window.h('dt', { key: 'address-label' }, 'Address'), window.h('dd', { key: 'address-value' }, data.get('address'))]
                    )
                  );
                }
              });
              window.CMS.registerPreviewTemplate('settings', SettingsPreview);
              
              console.log('Custom preview templates registered');
            } else {
              console.error('CMS object not available');
            }
          } catch (error) {
            console.error('CMS initialization error:', error);
          }
        }, 100);
      };
      script.onerror = function() {
        console.error('Failed to load Decap CMS script');
      };
      
      document.head.appendChild(script);
    }
    
    // Wait for DOM to be fully ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDecapCMS);
    } else {
      initDecapCMS();
    }
  </script>
</body>
</html>