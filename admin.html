<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link rel="icon" type="image/svg+xml" href="../vite.svg" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    #nc-root {
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <!-- Clean container for Decap CMS -->
  <div id="nc-root"></div>
  
  <script>
    // Prevent any automatic initialization
    window.CMS_MANUAL_INIT = true;
    
    // Clean initialization function
    function initDecapCMS() {
      console.log('Starting Decap CMS initialization...');
      
      // Ensure container is clean
      const container = document.getElementById('nc-root');
      if (container) {
        container.innerHTML = ''; // Clear any existing content
        console.log('Container cleared and ready');
      }
      
      // Load Decap CMS script dynamically to ensure proper timing
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
      script.onload = function() {
        console.log('Decap CMS script loaded');
        
        // Small delay to ensure everything is ready
        setTimeout(() => {
          try {
            if (window.CMS) {
              console.log('Initializing CMS with embedded config...');
              
              // Initialize with embedded DecapBridge PKCE configuration
              window.CMS.init({
                config: {
                  backend: {
                    name: 'git-gateway',
                    repo: 'kitgore/indigoroom',
                    branch: 'main',
                    auth_type: 'pkce',
                    base_url: 'https://auth.decapbridge.com',
                    auth_endpoint: '/sites/a554038d-d544-44e5-9ac7-09ba62b247a3/pkce',
                    auth_token_endpoint: '/sites/a554038d-d544-44e5-9ac7-09ba62b247a3/token',
                    gateway_url: 'https://gateway.decapbridge.com',
                    commit_messages: {
                      create: 'Create {{collection}} "{{slug}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      update: 'Update {{collection}} "{{slug}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      delete: 'Delete {{collection}} "{{slug}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      uploadMedia: 'Upload "{{path}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      deleteMedia: 'Delete "{{path}}" - {{author-name}} <{{author-login}}> via DecapBridge',
                      openAuthoring: 'Message {{message}} - {{author-name}} <{{author-login}}> via DecapBridge'
                    }
                  },
                  auth: {
                    email_claim: 'email',
                    first_name_claim: 'first_name',
                    last_name_claim: 'last_name',
                    avatar_url_claim: 'avatar_url'
                  },
                  logo_url: 'https://decapbridge.com/decapcms-with-bridge.svg',
                  site_url: 'https://kitgore.github.io/indigoroom',
                  display_url: 'https://kitgore.github.io/indigoroom',
                  media_folder: 'src/assets/uploads',
                  public_folder: '/indigoroom/src/assets/uploads',
                  collections: [
                    {
                      name: 'site_content',
                      label: 'Site Content',
                      files: [
                        {
                          label: 'Hours',
                          name: 'hours',
                          file: 'src/content/hours.json',
                          fields: [
                            {
                              label: 'Hours',
                              name: 'hours',
                              widget: 'list',
                              fields: [
                                { label: 'Day', name: 'day', widget: 'string' },
                                { label: 'Time', name: 'time', widget: 'string' }
                              ]
                            }
                          ]
                        },
                        {
                          label: 'Menu',
                          name: 'menu',
                          file: 'src/content/menu.json',
                          fields: [
                            {
                              label: 'Menu Categories',
                              name: 'categories',
                              widget: 'list',
                              fields: [
                                { label: 'Category Name', name: 'name', widget: 'string' },
                                {
                                  label: 'Items',
                                  name: 'items',
                                  widget: 'list',
                                  fields: [
                                    { label: 'Item Name', name: 'name', widget: 'string' },
                                    { label: 'Description', name: 'description', widget: 'text', required: false },
                                    { label: 'Price', name: 'price', widget: 'string', required: false }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          label: 'About',
                          name: 'about',
                          file: 'src/content/about.json',
                          fields: [
                            { label: 'Title', name: 'title', widget: 'string' },
                            { label: 'Description', name: 'description', widget: 'markdown' }
                          ]
                        },
                        {
                          label: 'Site Settings',
                          name: 'settings',
                          file: 'src/content/settings.json',
                          fields: [
                            { label: 'Site Title', name: 'title', widget: 'string' },
                            { label: 'Site Description', name: 'description', widget: 'text' },
                            { label: 'Contact Email', name: 'email', widget: 'string', required: false },
                            { label: 'Phone', name: 'phone', widget: 'string', required: false },
                            { label: 'Address', name: 'address', widget: 'text', required: false }
                          ]
                        }
                      ]
                    }
                  ]
                }
              });
              
              console.log('CMS initialization complete with DecapBridge PKCE config');
            } else {
              console.error('CMS object not available');
            }
          } catch (error) {
            console.error('CMS initialization error:', error);
          }
        }, 100);
      };
      script.onerror = function() {
        console.error('Failed to load Decap CMS script');
      };
      
      document.head.appendChild(script);
    }
    
    // Wait for DOM to be fully ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initDecapCMS);
    } else {
      initDecapCMS();
    }
  </script>
</body>
</html>